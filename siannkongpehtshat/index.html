<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>èª°æ˜¯è‡¥åº• - èªæ–‡æ•™å­¸ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #007bff; --spy: #dc3545; --bg: #f0f2f5; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h2 { color: var(--primary); margin-bottom: 25px; }
        .step-title { font-weight: bold; color: #555; margin-bottom: 15px; font-size: 1.1em; }
        
        /* è¼¸å…¥æ¡†ç¾åŒ– */
        input#roomCode { width: 80%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 12px; margin-bottom: 30px; text-align: center; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; }
        button { padding: 12px 25px; font-size: 16px; border: 2px solid var(--primary); background: white; color: var(--primary); border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        button.active { background: var(--primary); color: white; }
        button:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; }

        /* éš±è—å€å¡Š */
        .hidden { display: none; }

        /* å¡ç‰Œç¾åŒ– */
        #resultCard { margin-top: 20px; padding: 40px 20px; border: 4px solid var(--primary); border-radius: 20px; background: #fff; animation: flipIn 0.6s ease-out; }
        @keyframes flipIn { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0deg); opacity: 1; } }
        
        .word-main { font-size: 48px; font-weight: 900; color: #333; margin: 0; line-height: 1.2; }
        .word-pron { font-size: 24px; color: #666; margin: 10px 0; }
        .word-mean { font-size: 18px; color: #888; border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px; }
        
        .locked-msg { margin-top: 30px; color: #dc3545; font-weight: bold; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container" id="mainApp">
    <h2>ğŸ•µï¸ èª°æ˜¯è‡¥åº• - ç™¼ç‰Œç³»çµ±</h2>

    <div id="step1">
        <div class="step-title">æ­¥é©Ÿä¸€ï¼šè«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼</div>
        <input type="number" id="roomCode" placeholder="ä¾‹å¦‚ï¼š0121" pattern="\d*">
    </div>

    <div id="step2">
        <div class="step-title">æ­¥é©ŸäºŒï¼šå…¨ç­å…±æœ‰å¹¾çµ„ï¼Ÿ</div>
        <div class="btn-group">
            <button onclick="setTotalGroups(4)" id="total4">å…± 4 çµ„</button>
            <button onclick="setTotalGroups(5)" id="total5">å…± 5 çµ„</button>
            <button onclick="setTotalGroups(6)" id="total6">å…± 6 çµ„</button>
        </div>
    </div>

    <div id="step3" class="hidden">
        <div class="step-title">æ­¥é©Ÿä¸‰ï¼šä½ æ˜¯ç¬¬å¹¾çµ„ï¼Ÿ</div>
        <div class="btn-group" id="myGroupBtns">
            </div>
    </div>

    <div id="resultArea" class="hidden">
        <div id="resultCard">
            <div class="word-main" id="displayWord">ç´…èŒ¶</div>
            <div class="word-pron" id="displayPron">Ã¢ng-tÃª</div>
            <div class="word-mean" id="displayMean">è¯èªï¼šç´…èŒ¶</div>
        </div>
        <div class="locked-msg">âš ï¸ å¡ç‰Œå·²é–å®šï¼Œè«‹å„çµ„é–‹å§‹è¨è«–</div>
    </div>
</div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRXr-NxRpudrsU6BBpxKN4tOGZ5YmH_m4e1Fpcq1BvQyXjqO7wIhtVk3jRBpDQFKQpmmluUrbNfiDfm/pub?gid=0&single=true&output=csv';
    
    let state = {
        roomCode: '',
        totalGroups: 0,
        myGroup: 0
    };

    function hash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
            h = Math.imul(31, h) + str.charCodeAt(i) | 0;
        }
        return Math.abs(h);
    }

    // é¸æ“‡ç¸½çµ„æ•¸
    function setTotalGroups(n) {
        state.roomCode = document.getElementById('roomCode').value;
        if (!state.roomCode) {
            alert("è«‹å…ˆè¼¸å…¥æˆ¿é–“è™Ÿç¢¼");
            return;
        }
        state.totalGroups = n;

        // è¦–è¦ºåé¥‹
        [4,5,6].forEach(num => {
            document.getElementById('total' + num).classList.remove('active');
        });
        document.getElementById('total' + n).classList.add('active');

        // å‹•æ…‹ç”Ÿæˆã€Œç¬¬å¹¾çµ„ã€æŒ‰éˆ•
        const btnContainer = document.getElementById('myGroupBtns');
        btnContainer.innerHTML = '';
        for (let i = 1; i <= n; i++) {
            const btn = document.createElement('button');
            btn.innerText = `ç¬¬ ${i} çµ„`;
            btn.onclick = () => showCard(i);
            btnContainer.appendChild(btn);
        }

        document.getElementById('step3').classList.remove('hidden');
        // æ²å‹•åˆ°åº•éƒ¨
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // æŠ½ç‰Œä¸¦é¡¯ç¤ºçµæœ
    async function showCard(groupIndex) {
        state.myGroup = groupIndex;

        try {
            const response = await fetch(csvUrl);
            const data = await response.text();
            
            // è§£æ CSVï¼Œéæ¿¾æ¨™é¡Œåˆ—ï¼Œç¢ºä¿æœ‰è³‡æ–™
            const rows = data.split('\n')
                             .map(row => row.split(','))
                             .filter(r => r.length >= 6 && !r[0].includes("å¹³æ°‘"));

            const seed = hash(state.roomCode.toString());
            const pairIndex = seed % rows.length;
            const rowData = rows[pairIndex];

            // æ±ºå®šè‡¥åº•çµ„åˆ¥ (åŸºæ–¼ç¨®å­èˆ‡ç¸½çµ„æ•¸ï¼Œç¢ºä¿ä¸åŒå¹³æ¿çµæœä¸€è‡´)
            const spyGroup = (hash(seed.toString()) % state.totalGroups) + 1;

            // åˆ¤æ–·è©²é¡¯ç¤ºå¹³æ°‘(ABC)é‚„æ˜¯è‡¥åº•(DEF)
            let word, pron, mean;
            if (groupIndex === spyGroup) {
                word = rowData[3]; // D è‡¥åº•è©
                pron = rowData[4]; // E è‡¥åº•ç™¼éŸ³
                mean = rowData[5]; // F è‡¥åº•é‡‹ç¾©
            } else {
                word = rowData[0]; // A å¹³æ°‘è©
                pron = rowData[1]; // B å¹³æ°‘ç™¼éŸ³
                mean = rowData[2]; // C å¹³æ°‘é‡‹ç¾©
            }

            // æ¸²æŸ“ç•«é¢
            document.getElementById('displayWord').innerText = word;
            document.getElementById('displayPron').innerText = pron;
            document.getElementById('displayMean').innerText = "è¯èªï¼š" + mean;

            // éš±è—è¨­å®šå€ï¼Œé¡¯ç¤ºå¡ç‰Œ
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            document.body.style.background = "#e9ecef";

        } catch (error) {
            alert('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š');
            console.error(error);
        }
    }
</script>

</body>
</html>
