<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自訂翻牌 - 快速協作版</title>
    <style>
        :root {
            --bg-color: #f0f9ff;
            --container-bg-color: #e0f2f7;
            --btn-color: #20b2aa;
            --btn-hover-color: #008b8b;
            --card-front-color: #b3e0ff;
            --card-back-color: #81c784;
            --card-front-text: #005f99;
            --card-back-text: #004085;
        }
        .theme-style2 {
            --bg-color: #fffaf0;
            --container-bg-color: #ffeccf;
            --btn-color: #f59e0b;
            --btn-hover-color: #d97706;
            --card-front-color: #fbd38d;
            --card-back-color: #d8b4fe;
            --card-front-text: #92400e;
            --card-back-text: #6b21a8;
        }
        .theme-style3 {
            --bg-color: #1a202c;
            --container-bg-color: #2d3748;
            --btn-color: #4299e1;
            --btn-hover-color: #2b6cb0;
            --card-front-color: #4a5568;
            --card-back-color: #fcd34d;
            --card-front-text: #e2e8f0;
            --card-back-text: #713f12;
        }
        
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: #333;
            transition: background-color 0.5s;
            box-sizing: border-box;
            padding: 20px;
        }
        .size-buttons, .style-buttons { margin-bottom: 20px; }
        .style-btn, .size-btn, #apply-btn, .sync-btn, .edit-btn {
            padding: 8px 16px;
            font-size: 1em;
            cursor: pointer;
            background-color: var(--btn-color);
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .sync-btn { background-color: #4caf50; font-weight: bold; }
        .sync-btn:hover { background-color: #388e3c; }
        .edit-btn { background-color: #607d8b; } /* 灰色調區分 */
        .edit-btn:hover { background-color: #455a64; }

        .container {
            display: grid;
            gap: 2.5vw;
            padding: 2.5vw;
            background-color: var(--container-bg-color);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            box-sizing: border-box;
        }
        .card {
            width: 100%;
            padding-bottom: 70%;
            height: 0;
            background-color: var(--card-front-color);
            border-radius: 10px;
            cursor: pointer;
            perspective: 1000px;
            position: relative;
        }
        .card-inner {
            position: absolute;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            padding: 5px;
            box-sizing: border-box;
            word-wrap: break-word;
            text-align: center;
            font-weight: bold;
        }
        .card-front { background-color: var(--card-front-color); color: var(--card-front-text); }
        .card-back { background-color: var(--card-back-color); color: var(--card-back-text); transform: rotateY(180deg); }

        .mark-btn {
            position: absolute;
            bottom: 5px; right: 5px;
            width: 15px; height: 15px;
            border-radius: 50%;
            background-color: rgba(240, 240, 240, 0.5);
            z-index: 10;
        }
        .mark-btn.marked { background-color: rgba(255, 82, 82, 0.8); }

        .dictionary-input {
            width: 90%;
            max-width: 600px;
            background-color: var(--container-bg-color);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dictionary-input input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .dictionary-input textarea { width: 100%; min-height: 80px; padding: 10px; border-radius: 5px; box-sizing: border-box; }
        
        .footer { margin-top: 10px; text-align: center; font-size: 0.85em; color: #666; }
        .counter-container { display: flex; align-items: center; margin-bottom: 10px; }
        .subtle-text { font-size: 0.8em; color: #666; margin-bottom: 10px; }
        .action-button { padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body class="theme-style1">

    <div class="dictionary-input">
        <h3>多人同步模式</h3>
        <input type="text" id="sheet-url" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRY-SeJcGiStT_zloHzliRlEZ7-ivqer_voY-D6D3Py1TaIxWvluVSs45HP_qHguyhXunceTwGj191l/pub?output=csv">
        
        <div>
            <button id="load-sheet-btn" class="sync-btn">從試算表同步詞庫</button>
            <button class="edit-btn" onclick="window.open('https://docs.google.com/spreadsheets/d/1KAojsfq8A0ycK_YBzz93KhKU8h2OJEqzKEbwr3HsRfs/edit?usp=sharing', '_blank')">線上共編詞庫</button>
        </div>
        
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(0,0,0,0.1);">

        <h3>手動輸入模式</h3>
        <textarea id="custom-dictionary" placeholder="格式：翻牌後, 翻牌前"></textarea>
        <button id="apply-btn">套用並開始</button>
    </div>

    <div class="size-buttons">
        <button class="size-btn" onclick="shuffleCards(3)">3×3</button>
        <button class="size-btn" onclick="shuffleCards(4)">4×4</button>
        <button class="size-btn" onclick="shuffleCards(5)">5×5</button>
    </div>

    <div class="container"></div>

    <div class="style-buttons">
        <button class="style-btn" onclick="applyStyle('theme-style1')">式1</button>
        <button class="style-btn" onclick="applyStyle('theme-style2')">式2</button>
        <button class="style-btn" onclick="applyStyle('theme-style3')">式3</button>
    </div>

    <div class="action-buttons">
        <button id="reset-button" class="action-button" onclick="location.reload()">重新整理網頁</button>
    </div>

    <div class="footer">
        <p>設計者：Iônn, Àn-tsiong；<br>技術支援：フォックスコンの響き</p>
    </div>

    <div class="counter-container">
        <a href="https://www.hitwebcounter.com/" target="_blank">
            <img src="https://hitwebcounter.com/counter/counter.php?page=21440561&style=0008&nbdigits=6&type=page&initCount=0" title="Counters" Alt="Counters" border="0" />
        </a>
        <button id="share-button" style="margin-left:10px; padding:4px 8px; font-size:0.8em;">複製目前詞庫網址</button>
    </div>

    <script>
        const container = document.querySelector('.container');
        const customDictTextarea = document.getElementById('custom-dictionary');
        const sheetUrlInput = document.getElementById('sheet-url');
        let activeCards = [];
        let currentSize = 3;

        async function fetchGoogleSheet() {
            const url = sheetUrlInput.value.trim();
            try {
                const response = await fetch(url);
                const csvData = await response.text();
                const lines = csvData.split(/\r?\n/);
                activeCards = lines.map(line => {
                    const parts = line.replace(/，/g, ',').split(',');
                    return parts.length >= 2 ? { hanzi: parts[0].trim(), roman: parts[1].trim() } : null;
                }).filter(c => c !== null);

                if (activeCards.length > 0) {
                    customDictTextarea.value = activeCards.map(c => `${c.hanzi},${c.roman}`).join('\n');
                    alert(`同步成功！載入 ${activeCards.length} 組詞彙`);
                    shuffleCards(currentSize);
                }
            } catch (error) {
                alert("同步失敗，請檢查網路。");
            }
        }

        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function renderCards(size) {
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            const count = size * size;
            if (activeCards.length < count) {
                container.innerHTML = `<p style="grid-column:1/-1; text-align:center;">需至少 ${count} 組詞彙</p>`;
                return;
            }
            const selected = shuffleArray(activeCards).slice(0, count);
            selected.forEach(data => {
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face card-front">${data.roman}</div>
                        <div class="card-face card-back">${data.hanzi}</div>
                    </div>
                    <div class="mark-btn"></div>
                `;
                el.addEventListener('click', () => el.classList.toggle('flipped'));
                el.querySelector('.mark-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.target.classList.toggle('marked');
                });
                container.appendChild(el);
            });
        }

        function shuffleCards(size) { currentSize = size; renderCards(size); }
        function applyStyle(s) { document.body.className = s; }

        document.getElementById('load-sheet-btn').addEventListener('click', fetchGoogleSheet);
        document.getElementById('apply-btn').addEventListener('click', () => {
            const lines = customDictTextarea.value.trim().split('\n');
            activeCards = lines.map(l => {
                const p = l.replace(/，/g, ',').split(',');
                return p.length === 2 ? { hanzi: p[0].trim(), roman: p[1].trim() } : null;
            }).filter(c => c !== null);
            shuffleCards(currentSize);
        });

        window.onload = () => {
            // 嘗試讀取網址參數，若無則留空
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if (data) {
                try {
                    activeCards = JSON.parse(decodeURIComponent(escape(atob(data))));
                    customDictTextarea.value = activeCards.map(c => `${c.hanzi},${c.roman}`).join('\n');
                } catch(e) {}
            }
            shuffleCards(3);
        };
    </script>
</body>
</html>
